<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>Simon Bedford</title>
		<meta name="description" content="">
		<meta name="author" content="Simon Bedford">

		<link rel="stylesheet" href="https://simonb83.github.io/theme/css/foundation.css" />
		<link rel="stylesheet" href="https://simonb83.github.io/theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="https://simonb83.github.io/theme/css/custom.css" />

		<!-- GOOGLE WEB FONTS -->
		<link href='https://fonts.googleapis.com/css?family=Droid+Sans:400,700|Droid+Sans+Mono|Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="https://simonb83.github.io/theme/css/alt-fonts.css" />

		<link rel="stylesheet" href="https://simonb83.github.io/css/rnn_star_trek.css" type="text/css" />

		<script src="https://simonb83.github.io/theme/js/modernizr.js"></script>

		<!-- Feeds -->
		<link href="https://simonb83.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Simon Bedford Atom Feed" />


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			jax: ["input/TeX", "output/HTML-CSS"],
			tex2jax: {
				inlineMath: [ ['$', '$'] ],
				displayMath: [ ['$$', '$$']],
				processEscapes: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
			},
			messageStyle: "none",
			"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
		});
		</script>
		<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">Simon&nbsp;Bedford</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
						<li><a href="https://simonb83.github.io">Home</a></li>
						<li><label>Categories</label></li>
							<li ><a href="https://simonb83.github.io/category/books.html">Books</a></li>
							<li ><a href="https://simonb83.github.io/category/coding.html">Coding</a></li>
							<li ><a href="https://simonb83.github.io/category/customer-experience.html">Customer Experience</a></li>
							<li class="active"><a href="https://simonb83.github.io/category/data-science.html">Data Science</a></li>
							<li ><a href="https://simonb83.github.io/category/deep-learning.html">Deep Learning</a></li>
							<li ><a href="https://simonb83.github.io/category/ideas.html">Ideas</a></li>
							<li ><a href="https://simonb83.github.io/category/machine-learning.html">Machine Learning</a></li>
							<li ><a href="https://simonb83.github.io/category/maths.html">Maths</a></li>
							<li ><a href="https://simonb83.github.io/category/other.html">Other</a></li>
							<li ><a href="https://simonb83.github.io/category/tech.html">Tech</a></li>

						<!-- <li><label>Links</label></li>
							<li><a href="http://getpelican.com/">Pelican</a></li>
							<li><a href="http://python.org/">Python.org</a></li>
							<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
							<li><a href="#">You can modify those links in your config file</a></li>
 -->


						<li><label>Monthly Archives</label></li>
									<li><a href="/posts/2016/11/index.html">November 2016 (3)</a></li>
									<li><a href="/posts/2016/10/index.html">October 2016 (4)</a></li>
									<li><a href="/posts/2016/03/index.html">March 2016 (1)</a></li>
									<li><a href="/posts/2016/02/index.html">February 2016 (2)</a></li>
									<li><a href="/posts/2016/01/index.html">January 2016 (1)</a></li>
									<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
									<li><a href="/posts/2015/03/index.html">March 2015 (2)</a></li>
									<li><a href="/posts/2015/02/index.html">February 2015 (6)</a></li>

						<li><label>Social</label></li>
							<li><a href="http://github.com/simonb83">GitHub</a></li>
							<li><a href="https://mx.linkedin.com/in/simonbedford">LinkedIn</a></li>
							<li><a href="http://twitter.com/simonb83">Twitter</a></li>
					</ul>	
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="https://simonb83.github.io/">Simon Bedford</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<!-- <ul class="left">
								<li ><a href="https://simonb83.github.io/category/books.html">Books</a></li>
								<li ><a href="https://simonb83.github.io/category/coding.html">Coding</a></li>
								<li ><a href="https://simonb83.github.io/category/customer-experience.html">Customer Experience</a></li>
								<li class="active"><a href="https://simonb83.github.io/category/data-science.html">Data Science</a></li>
								<li ><a href="https://simonb83.github.io/category/deep-learning.html">Deep Learning</a></li>
								<li ><a href="https://simonb83.github.io/category/ideas.html">Ideas</a></li>
								<li ><a href="https://simonb83.github.io/category/machine-learning.html">Machine Learning</a></li>
								<li ><a href="https://simonb83.github.io/category/maths.html">Maths</a></li>
								<li ><a href="https://simonb83.github.io/category/other.html">Other</a></li>
								<li ><a href="https://simonb83.github.io/category/tech.html">Tech</a></li>
						</ul> -->
                        <ul class="right">                                                                                                                                           
                                                                                                          
路路路路                                                                                                                                       
                                     <li><a href="https://simonb83.github.io/pages/about.html">About</a></li>                                    
                                                                                                                                          
                                                                                                                                             
                        </ul>  
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>Recurring Neural Networks and Star Trek</h2>
	<p>Earlier this year I wrote about <a href="/machine-learning-food-classification.html">Convolutional Neural Networks (CNNs) and their applications to image classification</a>.</p>
<p>As I discussed, CNNs are very powerful for image classification, giving better-than-human results in some cases, however they do not provide a singular solution to any given problem.</p>
<p>One limitation of CNNs is that they have no notion of time or sequences, that is to say that each prediction is totally independent of any previous predictions.</p>
<p><img alt="simple_network" src="/images/rnn1_simple_network.png" /></p>
<p>In the diagram above, each input gives an output independent of the other inputs; one could change the order of the inputs and expect to obtain the same output.</p>
<p>However there are many types of problems for which we may wish to apply machine learning and neural network-based models, but where we need the ability to process and recognize time-dependent sequences.</p>
<p>One such example is language translation where you might try and process sentences one word at a time, and where the translation of a particular word will depend on the words that came before.</p>
<p>Similarly, if you want to build a model to describe a scene in an image word-by-word, then you would want the ability to take previous words into account as the model generates the description.</p>
<p>In fact, these sorts of sequential models are useful for many different problems in Natural Language Processing, as language is inherently sequential and highly context-dependent.</p>
<p>In this post I will focus on a particular application called Character Level Language modeling where the aim is to build a model capable of generating text one character at a time.</p>
<p>The approach used is based on supervised learning, and as such we need a training dataset. For this exercise I decided to use the complete scripts of Star Trek: The Next Generation.</p>
<p>As with the post on CNNs, I will try and keep the explanations relatively non-technical while still getting across the key ideas. If you just want to see the output, you can skip straight to the <a href="part_3">results</a> section.</p>
<ol>
<li><a href="#part_1">Brief Introduction to Recurring Neural Networks</a></li>
<li><a href="#part_2">Baseline Results Using Markov Chain Models</a></li>
<li><a href="#part_3">Star Trek Script Generation Using RNNs</a></li>
</ol>
<h3 id="part_1">1. Brief Introduction to Recurring Neural Networks</h3>

<p><strong>Fully Connected Neural Networks</strong></p>
<p>Let's start with a quick reminder of what fully-connected neural networks look like.</p>
<p><img alt="alt neuron_2" src="/images/capstone_neuron_2.png" /></p>
<p>The picture above depicts a single 'neuron' which at its core is nothing more than a function which:</p>
<ol>
<li>Receives input <strong><em>X</em></strong></li>
<li>Calculate the linear transform <strong><em>wX + b</em></strong></li>
<li>Passes the result through an activation function, <strong><em>&sum;</em></strong>, in order to produce the output of the neuron</li>
</ol>
<p>The idea of the activation function is to add complexity to the model and ensure that neurons do not 'fire' (produce output) all of the time, but only some of the time based on certain conditions.</p>
<p>The activation functions used in practice often look like these:</p>
<p><img alt="activation_functions" src="/images/capstone_activation.png" /></p>
<p>A fully-connected neural network is created by combining many of these neurons into layers, and connecting the layers together in such a way that in each layer (except the input and output layers) every neuron is connected to every other neuron in the preceding and following layers.</p>
<p><strong>Recurring Neural Networks</strong></p>
<p>If we were to use the neuron above for processing a sequence of inputs, $ x_1, x_2, x_3,... $, it is clear that the model cannot take into account any notion of order or context, as at each step the output is dependent only upon the current input  $ x_t $ and the internal parameters.</p>
<div class="math">$$ Output_t = f(x_t) $$</div>
<p>What we need instead is a model that take into account both the current input  $ x_t $ as well as all of the previous inputs up until that point:</p>
<div class="math">$$ Output_t = f(x_1, x_2,..., x_{t - 1}, x_t) $$</div>
<p>Recurring Neural Networks (RNNs) provide exactly this type of model. The simplest RNN is based on the following set-up:</p>
<p><img alt="rnn_neuron_1" src="/images/rnn1_rnn_1.png" /></p>
<p>Here the model has an internal state $ h_t $ which is updated at each time step according to a recurrence relation:</p>
<div class="math">$$ h_t = f(h_{t - 1}, x_t) $$</div>
<p>That is to say that the hidden state at time t is a function of the previous hidden state at time t-1 along with the input $ x_t $, with $ h_{t - 1} $ and $ x_t $ being combined using learnable parameters $ W_{hh} $ and $ W_{xh} $.</p>
<p>The result of this combination is then passed through an activation function to generate an output.</p>
<p>In a vanilla Recurring Neural Network, $ tanh $ is used for the activation function, and the hidden state is calculated by:</p>
<div class="math">$$ h_t = tanh( W_{hh} .  h_{t-1} + W_{xh} . x_t) $$</div>
<p>The prediction at time t, $ y_t $, can then be calculated from the current hidden state using a separate set of parameters:</p>
<div class="math">$$ y_t = W_{yh} . h_t $$</div>
<p>The hidden state h, serves to maintain the 'history' of all of the inputs, as at each step the value of h is a function of all of the inputs up until that point.</p>
<p><strong>Simple Example</strong></p>
<p>To try and illustrate how this can work in practice, I will use a slightly contrived example, but hopefully it will help to demonstrate how we can take advantage of the history of inputs via the hidden state.</p>
<p>Suppose we wish to construct a very simple timer that activates after 10 steps in time.</p>
<p>The function will receive 1s as input, representing single steps in time, and suppose it 'activates' once its output becomes greater than 0.5.</p>
<p>We can model this using the following simplified RNN unit:</p>
<p><img alt="rnn_neuron_2" src="/images/rnn1_rnn_2.png" /></p>
<p>Note that this is exactly the same as in the definition of the RNN from above, setting $ W_{hh} = 1 $, $ W_{xh} = 0.1 $, and using a step function instead of $ tanh $ as the activation function.</p>
<p>Setting h to initially be 0, look at what happens to the hidden state and output as each step is processed:</p>
<table id="rnn_example">
    <tr>
        <th>Step</th>
        <th>Input</th>
        <th>Hidden State</th>
        <th>Output</th>
    </tr>
    <tr>
        <td>0</td>
        <td>-</td>
        <td>0</td>
        <td>-</td>
    </tr>
    <tr>
        <td>1</td>
        <td>1</td>
        <td>0.10</td>
        <td>0</td>
    </tr>
    <tr>
        <td>2</td>
        <td>1</td>
        <td>0.20</td>
        <td>0</td>
    </tr>
    <tr>
        <td>3</td>
        <td>1</td>
        <td>0.30</td>
        <td>0</td>
    </tr>
    <tr>
        <td>4</td>
        <td>1</td>
        <td>0.40</td>
        <td>0</td>
    </tr>
    <tr>
        <td>5</td>
        <td>1</td>
        <td>0.50</td>
        <td>1</td>
    </tr>
    <tr>
        <td>6</td>
        <td>1</td>
        <td>0.60</td>
        <td>1</td>
    </tr>
    <tr>
        <td>7</td>
        <td>1</td>
        <td>0.70</td>
        <td>1</td>
    </tr>
    <tr>
        <td>8</td>
        <td>1</td>
        <td>0.80</td>
        <td>1</td>
    </tr>
</table>

<p>By incorporating all of the history of the inputs into the output of the model, it is possible to obtain this time or sequence-dependent behaviour.</p>
<p>(Note: in practice, due to computational restraints, it is not normally possible to process all of the input in one go, and 'mini batches' of input are typically used. Thus the value of the hidden state will be based on all of the history of the current mini-batch up until that point, rather than the history of the whole sequence.)</p>
<p><strong>LSTM</strong></p>
<p>I have just described what is really the simplest type of RNN unit used in practice. One of the problems with this model is that is has difficulty learning long-term dependencies within sequences.</p>
<p>Fortunately there are other types of Recurrent Neural Network units that are a bit more complicated to describe, but that end up being more powerful models. One such unit is called a Long Short Term Memory unit, or LSTM.</p>
<p>In principle, the idea is the same, whereby at each step we are just applying a recurrence relation, albeit a more complex one. Without going too much into the mathematical details, the basic setup is the following.</p>
<p><img alt="lstm_1" src="/images/rnn1_lstm_1.png" /></p>
<p>Whereas in a simple RNN we were maintaining and updating a hidden state $ h_t $ at every step, in an LSTM we keep track of two variables: the hidden state $ h_t $ along with an internal cell state $ c_t $.</p>
<p>The cell state works a bit like an internal memory that can 'remember' or 'forget' things as needed.</p>
<p>The first step is to decide how much of the previous cell state to forget. In order to do this, the LSTM looks at the incoming value $ x_t $, along with previous hidden state $ h_{t-1} $ and outputs a number between 0 and 1, where 0 means completely forget and 1 means completely remember.</p>
<p><img alt="lstm_2" src="/images/rnn1_lstm_2.png" /></p>
<p>The second step is to decide how much of the input to keep. Once again, the LSTM looks at the incoming value $ x_t $ and the previous hidden state $ h_{t-1} $ and decides which bits of information to keep, scaled by a certain factor.</p>
<p><img alt="lstm_3" src="/images/rnn1_lstm_3.png" /></p>
<p>We are now in a position to update the cell's memory, or internal state, $ c_t $:</p>
<div class="italic">New Cell State = Remembered Previous State + Kept Input</div>

<p><br />
<img alt="lstm_4" src="/images/rnn1_lstm_4.png" /></p>
<p>Finally, we decide how much of the new cell state we want to output, which is based on the recently updated cell state scaled by a particular factor. The scaling factor is again based on the incoming value $ x_t $ and the previous hidden state $ h_{t-1} $.</p>
<p><img alt="lstm_5" src="/images/rnn1_lstm_5.png" /></p>
<p>If you're feeling a bit confused at this point, don't worry. There's a lot going on and it took me quite a long time to really get my head around this model.</p>
<p>The LSTM can be summarized more simply:</p>
<ol>
<li>There is an internal cell state, or memory, c</li>
<li>At each time step, the cell state is updated:<ul>
<li>Part of the old cell state is 'forgotten'</li>
<li>Part of the new input is 'kept'</li>
</ul>
</li>
<li>The output of the cell is based on some of the internal state scaled in a certain way (i.e. only parts of the cell state become output)</li>
</ol>
<h3 id="part_2">2. Baseline Results Using Markov Chain Models</h3>

<p><strong>Problem Summary</strong></p>
<p>Before moving on, I want to be a bit clearer about what it is that we hope to achieve. I mentioned earlier that the aim is to build a Character Level Language model, capable of generating text.</p>
<p>In more simple terms, this means that we want to build a model based on individual characters, for example individual letters, spaces, punctuation marks etc., that outputs a prediction for the next character based upon the current character.</p>
<p>For example, if we were to start with a capital C, we might want the model to proceed as follows:</p>
<p><img alt="rnn_neuron_2" src="/images/rnn1_markov_1.png" /></p>
<p><strong>The Data</strong></p>
<p>The data comes as a single 12 MB text file, containing formatted scripts complete with indentations, newlines, scene descriptions, stage directions etc.</p>
<p>As such, we would also hope that the model is capable of generating text that obeys the same formatting style:</p>
<div class="highlight"><pre> 7    ANGLE EMPHASIZING PICARD AND DATA
 As Picard turns to Data:
                PICARD
        You will agree, Data, that
        Starfleet&#39;s instructions are
        difficult?
</pre></div>


<p><br />
<strong>Markov Chain Models</strong></p>
<p>It is worth noting that different types of language generation algorithms have been around for a long time, and a quite common one is based on mathematical models called Markov Chains.</p>
<p>A Markov Chain is a probabalistic model which has the key property that the future is based only on the present.</p>
<p>For example, if you were to use a Markov Chain to model some sequence $ x_1, x_2, x_3,...,x_n $, then at any given moment $ i $, the next step $ x_{i + 1} $ is dependent only upon the current state $ x_i $.</p>
<p>For example, a simple dice-based board game such as Snakes &amp; Ladders is an example of a Markov Chain:</p>
<ol>
<li>It is probabilistic - your next position is based on the random outcome of a throw of the dice</li>
<li>Your next position is only dependent on your current position; how you got to where you are now does not make any difference</li>
</ol>
<p><strong>Markov Chain Models in Practice</strong></p>
<p>Building and using a Markov Chain for generating text is actually quite simple. For example, suppose that we start with some simple training text like:</p>
<p>"Captain Picard and the Enterprise"</p>
<p>All that is required for building a character-level model is to step through the text one character at a time and create a table of all of the pairs of characters that precede one another.</p>
<p>For example, for the first few characters:</p>
<p>'' &rarr; 'C'</p>
<p>'C' &rarr; 'a'</p>
<p>'a' &rarr; 'p'</p>
<p>We end up with the following table:</p>
<table id="markov_freqs">
    <tr>
        <th class="col1">Preceding</td>
        <th class="col2">Following</td>
    </tr>
    <tr>
        <td class='col1'>''</td>
        <td class='col2'>C</td>
    </tr>
    <tr>
        <td class='col1'>P</td>
        <td class='col2'>['i']</td>
    </tr>
    <tr>
        <td class='col1'>i</td>
        <td class='col2'>['n', 'c', 's']</td>
    </tr>
    <tr>
        <td class='col1'>E</td>
        <td class='col2'>['n']</td>
    </tr>
    <tr>
        <td class='col1'>t</td>
        <td class='col2'>['a', 'h', 'e']</td>
    </tr>
    <tr>
        <td class='col1'>C</td>
        <td class='col2'>['a']</td>
    </tr>
    <tr>
        <td class='col1'>s</td>
        <td class='col2'>['e']</td>
    </tr>
    <tr>
        <td class='col1'> </td>
        <td class='col2'>['P', 'a', 't', 'E']</td>
    </tr>
    <tr>
        <td class='col1'>c</td>
        <td class='col2'>['a']</td>
    </tr>
    <tr>
        <td class='col1'>r</td>
        <td class='col2'>['d', 'p', 'i']</td>
    </tr>
    <tr>
        <td class='col1'>h</td>
        <td class='col2'>['e']</td>
    </tr>
    <tr>
        <td class='col1'>p</td>
        <td class='col2'>['t', 'r']</td>
    </tr>
    <tr>
        <td class='col1'>e</td>
        <td class='col2'>C</td>
    </tr>
    <tr>
        <td class='col1'>d</td>
        <td class='col2'>[' ', ' ']</td>
    </tr>
    <tr>
        <td class='col1'>n</td>
        <td class='col2'>[' ', 'd', 't']</td>
    </tr>
    <tr>
        <td class='col1'>a</td>
        <td class='col2'>['p', 'i', 'r', 'n']</td>
    </tr>
</table>

<p>Generating new text is as simple as starting with a particular letter, and then using the table to identify what the next character should be at each stage. If there are multiple options we simply pick one at random.</p>
<p>For example, starting with the letter C, one possible output could be:</p>
<div class="highlight"><pre>Can anteCain En teCa
</pre></div>


<p><br />
It is also possible to do this using pairs of characters (i.e. 'Ca' &rarr; 'pt', 'ap' &rarr; 'ta' etc.), triplets of characters or even complete words.</p>
<p><strong>Some Results</strong></p>
<p>To see how well Markov Chains perform in practice, here are some results based on training the model on the complete Star Trek TNG scripts, using single characters, pairs, triplets, 4-grams and 5-grams.</p>
<p>In each of the following models, I attempted to generate 2,000 characters of text based upon the constructed character transition tables.</p>
<p><strong>Single Character Model</strong></p>
<div class="highlight"><pre>STAR TREK: vero rintove is.
</pre></div>


<p><br />
For the single-character model, at first the output was nearly all blank spaces. This is because, due to the script formatting, there are a lot of tabs and newlines, and so as soon as the model generates a some sort of white-space, it will almos certainly continue to follow this with more blank space.</p>
<p>In the end I had to feed in an initial bit of text, called a 'seed' (in this case 'STAR TREK'), in order to generate anything at all, but even here it only managed a few nonsensical characters before returning only blank space.</p>
<p><strong>Pairs of Characters</strong></p>
<div class="highlight"><pre>        RIKERTION Bould
to the ENTINUED: (OPTICASTARD
        Yest ashas aways fathe the ded ing to
                                    taptand stor
        We&#39;s flicare effew am crent bel loordents.
Borgantion afteraly, airal.
</pre></div>


<p><br />
Once you start using pairs of characters, the model can output text without needing a seed, however most of it just looks like nonsense.</p>
<p>The model does seem to start to replicate some of the formatting, such as multiple tabs and newlines, and in some cases there are the briefest hints of Star Trek, such as <em>RIKERTION</em>, or in other cases <em>DATA</em> and <em>Borgantion</em>.</p>
<p><strong>Triplets of Characters</strong></p>
<div class="highlight"><pre>         CONTINUED: (2)
Picard is gazing)
        Here is walk me to various
ands through than assador
        alling attentitly
        If the recommitting all right problement in he&#39;s not the
</pre></div>


<p><br />
By the time you get to using triplets of characters, most of the words are recognizably English, even if most of the sentences don't make any sense.</p>
<p>The formatting overall is much more script-like, and you even start to get things like:</p>
<div class="highlight"><pre>MING STATION - ACT THREE         STAR TREK: &quot;Birthrough a feelian emember One?
</pre></div>


<p>which could almost be out of a Star Trek episode.</p>
<p><strong>4-Grams</strong> (four characters in a row)</p>
<div class="highlight"><pre>40   INT. REPORTER ROOM
Similar containly
        me. I will not serve ident made vine of his look of your has claim, Worf?
Worf REACTS.
            DATA&#39;S VOICE
        immediately that just station as both for Wesley which wears agony others at the cape (o.s.)
        find here -- your name?
Radue could did the doesn&#39;t happened... so now a heavy...
                RIKER
                RIKER
            (to Kareer...
</pre></div>


<p><br />
Using 4-grams, things look even better, with line-numbers (in no particular order), and perhaps even some Klingon (<em>K'MTAR</em>).</p>
<p><strong>5-Grams</strong> (five characters in a row)</p>
<div class="highlight"><pre>                STAR TREK: &quot;The Pegasus&quot; REV. 7/17/92 - ACT FIVE                        KAMIE                USS ENTERPRISE - TRANSPORTER EFFECT stars
still accumulated the
window operation&#39;s birth...

       36.
47   OMITTED

39A
39B  ON ALBERT, the faction... she&#39;s heard so much a device. Finally nods. Picard leans closer... It won&#39;t belonged to get them.

No answer would
        narrow-minder of Honor&quot; - REV. 01/26/93 - ACT THREE                          23.

14   INT. MAIN BRIDGE

The computer
        claimed this place.
</pre></div>


<p><br />
Sequences of 5-characters was the most complex Markov Chain model I built, and I think it is pretty amazing how much complexity such a simple model can generate.</p>
<p>Even though the sequences of words don't really mean anything, the model is capable of generating pretty-well formatted output, it includes a title, numerous line numbers etc. </p>
<p>Given that such a simple and easy-to-build model can perform this well, we would need an RNN-based model to do significantly better given the increased complexity and required computational power.</p>
<h3 id="part_3">3. Star Trek Script Generation Using RNNs</h3>

<p><strong>Training Setup</strong></p>
<p>In order to train an RNN using the Star Trek data, I used Torch along with a <a href="https://github.com/jcjohnson/torch-rnn">library</a> created by Justin Johnson from Stanford University, running on an Amazon Web Services GPU g2.2x Large instance.</p>
<p>I experimented with a number of network parameters, including trying both simple RNN as well as LSTM units. The best results were based on a network with the following setup:</p>
<table>
    <tr>
        <td>Basic unit:</td>
        <td>LSTM</td>
        <td>See overview above.</td>
    </tr>
    <tr>
        <td>Number of layers:</td>
        <td>3</td>
        <td>This is the depth of the network, meaning there were three layers stacked on top of each other.</td>
    </tr>
    <tr>
        <td>RNN Size:</td>
        <td>256</td>
        <td>This is the number of hidden units in each layer of the network.</td>
    </tr>
    <tr>
        <td>Sequence Length:</td>
        <td>200</td>
        <td>The size of the sequence used during training; as I mentioned earlier it is not feasible to train on all of the text at the same time. Here the network is trained on sequences of 200 characters.</td>
    </tr>
</table>

<p>The remaining network parameters were based on defaults as described <a href="https://github.com/jcjohnson/torch-rnn/blob/master/doc/flags.md#preprocessing">here</a>.</p>
<p><strong>Loss Curve</strong></p>
<p>As with any suprvised machine learning problem, we already have the 'answer' that the network should output in any given situation, in this case the next character in a sequence.</p>
<p>During training the idea is to adjust the internal network weights in such a way as to make the actual and desired output as close together as possible. In order to do this we use a loss function that captures how 'wrong' the network is, and so the goal during training is to minimize this loss.</p>
<p>It is quite common to visualize how the loss evolves over time during training in order to get an idea of how the network is behaving and evolving, whether it is heading in the right direction and whether or not it seems to be improving on its results or has reached some kind of plateau (convergence).</p>
<p>Below is such a visualization for the best network mentioned above. The red line represents the loss as calculated on the training data being used at each iteration. The blue line represents the loss as calculated on a separate set of data used exclusively for testing or validation purposes.</p>
<p><img alt="rnn_neuron_1" src="/images/rnn1_loss_curve.png" /></p>
<p>You can see that the training loss starts out relatively high and decreases pretty quickly within the first 5,000 iterations. Both the training and validation loss seem to have leveled out somewhere between iteration 5,000 and 10,000, and they only improve very slightly thereafter.</p>
<p>You can also see that the red and blue lines are pretty close together. This is a good thing as it is an indicator that the model is not overfitting too much on the training data and is able to generalize reasonably-well to the validation data.</p>
<p>The noise in the training loss is due to the fact that we are training the model using only subsets of input data, rather than all at the same time. You can imagine that for any given sequence of characters, the internal weights that minimize the output loss will probably not be the same set of weights that optimize the loss for any other sequence.</p>
<p><strong>Generating Text</strong></p>
<p>So what happens when we generate some text using the RNN (LSTM) model?</p>
<p>Before looking at some examples, I need to mention another parameter we can control while sampling called the 'temperature', which is in the range $ 0 &lt; temperature &lt;= 1 $.</p>
<p>In effect the temperature controls how risky or varied the model is in predicting new characters. When the temperature is low, the model tends to make 'safer' but more boring predictions. At high temperatures, the model will take more chances and make more varied predictions, but is also more likely to make mistakes.</p>
<p><strong>Temperature = 1</strong></p>
<div class="highlight"><pre>49   ANOTHER ANGLE (OPTICAL)

    The outing is enraged, served. Worf, Riker moving
    over on a silent monitor in rage... he&#39;s admired with
    various memory program. Then on his computer connects.

                    BEVERLY
            And now! I don&#39;t reveal it
            off.

                    WORF
            Of course I small provide them.

                    KYLE
            You don&#39;t remember it?

                    GUECHREY
            What is that? But that&#39;s all we
            do as fast...

                    GEOWDER
            Your tent? What&#39;re has you?
            I neededed get more returns to
            travel.

                    DATA
            The descepants will give no
            routine incident. And that Ferengi
            are over enough to assist in
            Four, shuttlecraft.

    Reactions. He walks off from the art of a compartment.
</pre></div>


<p><br />
At the highest temperature we get some pretty well formatted text, but you can see that there are some spelling mistakes: GUECHREY, neededed, descepants.</p>
<p><strong>Temperature = 0.1</strong></p>
<div class="highlight"><pre>                    PICARD
                (to com)
            Computer, report to the ship and
            are a little second three three
            hours.

                    PICARD
                (to com)
            The computer readings are all
            there is a second on the ship.

                    PICARD
            I do not know what the contract
            to the ship is a little series.

                    PICARD
                (to com)
            The ship is a possible container
            of the ship and the ship is a
            sense of the ship and as a second
            second second officers are all
            there is a second officer to the
            Enterprise to the Enterprise.

                    PICARD
                (to com)
            Computer, locate the ship and the
            Enterprise is the ship and the
            Enterprise is the ship and the
            Enterprise is the ship and the
            Enterprise is the ship and all
            the ship is a little second three
            hundred thousand three hundred
            thousand three hundred thousand
            that the contract with the ship
            and the ship is a second on the
            Enterprise.

                    PICARD
                (to com)
            The ship is a little distance of
            the ship and the ship is a little
            distance to the ship and the ship
            is a little band of a second on
            the Enterprise.
</pre></div>


<p><br />
Here the model is making the safest possible predictions, and it ends up almost exclusively generating dialogue by Captain Picard (sometimes there is some Commander Riker dialogue too). It also repeats itself a lot, as if stuck in some kind of loop.</p>
<p><strong>Temperature = 0.75</strong></p>
<div class="highlight"><pre>21   INT. NEEDED GEORDI (OPTICAL)

    as he heads toward them and DROPPING SOUNDS.

                    DATA
            Sir, that is not advantaged at
            several days onboard to bodily
            human are weak. We have learned
            a stature of the past... literard
            on the Stargazer&#39;s power range,
            the Enterprise is a personal
            board and transported. You lost
            them estimate a logs as far and
            deck enough as she fights.

                    RIKER
            Unless the band of generators with
            me in it. Only the power took a
            living graviton development.

                    WORF
            Return to your legs?

                    PICARD
                (faster historical)
            I don&#39;t think you would participate
            himself.

                    PICARD
            What he were so quite clear?

                    RIKER
            I can&#39;t point this bad former --
            much decision.

    Kyle shines from his words and the shuttle at his
    head.

      STAR TREK: &quot;Data&#39;s Day&quot; - REV. 10/15/90 - ACT TWO      27.

33A  CONTINUED:

                    PICARD
            I&#39;m sure this is that the report
            knows what comes.
</pre></div>


<p><br />
A pretty good sweet-spot seems to be somewhere around Temperature of 0.75, where we get quite varied output, with very few spelling mistakes.</p>
<h3>Conclusion</h3>
<p>Despite the fact that the model is a long way off generating a full script, or even any meaningful dialogue, I find the results to be absolutely amazing.</p>
<p>Remember that this is a single character model that works one letter at a time, and does not know anything about words, punctuation or script-writing rules. And yet, not only does it generate proper English words, but it also has learned a number of quite complex rules.</p>
<p>For a start all of the lines have almost perfect indentation and line-length:</p>
<p><em>Original Script:</em></p>
<div class="highlight"><pre>                PICARD
        You will agree, Data, that
        Starfleet&#39;s instructions are
        difficult?
</pre></div>


<p><br />
<em>Generated Output:</em></p>
<div class="highlight"><pre>                PICARD
        Begin and it has already also
        get a long...
</pre></div>


<p><br />
Furthermore, it has figured out that episode names have a particular format, including a name (enclosed in quotation marks), a date and an act:</p>
<p><em>Original Script:</em></p>
<div class="highlight"><pre>      STAR TREK: &quot;Haven&quot; - 7/13/87 - ACT THREE
</pre></div>


<p><br />
<em>Generated Output:</em></p>
<div class="highlight"><pre>    STAR TREK: &quot;The Shroud&quot; - 2/1/88 - ACT FIVE
</pre></div>


<p><br />
It includes dialogue and scene notes and correctly opens and closes brackets:</p>
<div class="highlight"><pre>                BEVERLY
            (moves quickly to Riker)
</pre></div>


<p><br />
Yes, the model is a lot more complex than the Markov Chain-based models I introduced earlier, but the results are also far superior.</p>
<p>The single-character markov chain model was only able to generate a little bit of gibberish followed by blank spaces, and even the 5-gram Markov Chain model did not produce anything as accurate as the RNN.</p>
<p><em>Notes</em>:</p>
<p>A big thanks to Andrej Karpathy for his <a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">blog post</a> which inspired me to look at RNNs as single-character language models.</p>
<p>I also found <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/">Christopher Olah's blog post on LSTMs</a> to be one of the clearer explanations out there.</p>
<p>Accompanying code is on <a href="https://github.com/simonb83/rnn_star_trek">GitHub</a>.</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
	<hr/>
	<h6>Written by <a href="https://simonb83.github.io/author/simon-bedford.html">Simon Bedford</a> in <a href="https://simonb83.github.io/category/data-science.html">Data Science</a> on Mon 28 November 2016. Tags: <a href="https://simonb83.github.io/tag/data-science.html">data-science</a>, <a href="https://simonb83.github.io/tag/machine-learning.html">machine-learning</a>, <a href="https://simonb83.github.io/tag/neural-network.html">neural-network</a>, </h6>
</article>

<hr/>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<!-- <div class="panel">
								<h5>Links</h5>
								<ul class="side-nav">
									<li><a href="http://getpelican.com/">Pelican</a></li>
									<li><a href="http://python.org/">Python.org</a></li>
									<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
									<li><a href="#">You can modify those links in your config file</a></li>
								</ul>
							</div> -->

							<div class="panel">
								<h5>Categories</h5>
								<ul class="side-nav">
										<li><a href="category/books.html">Books</a></li>
										<li><a href="category/coding.html">Coding</a></li>
										<li><a href="category/customer-experience.html">Customer Experience</a></li>
										<li><a href="category/data-science.html">Data Science</a></li>
										<li><a href="category/deep-learning.html">Deep Learning</a></li>
										<li><a href="category/ideas.html">Ideas</a></li>
										<li><a href="category/machine-learning.html">Machine Learning</a></li>
										<li><a href="category/maths.html">Maths</a></li>
										<li><a href="category/other.html">Other</a></li>
										<li><a href="category/tech.html">Tech</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
									<li><a href="/tag/python.html" class="tag-4">python</a></li>
									<li><a href="/tag/science.html" class="tag-4">science</a></li>
									<li><a href="/tag/cooking.html" class="tag-4">cooking</a></li>
									<li><a href="/tag/crypto-currencies.html" class="tag-4">crypto-currencies</a></li>
									<li><a href="/tag/books.html" class="tag-4">books</a></li>
									<li><a href="/tag/machine-learning.html" class="tag-1">machine-learning</a></li>
									<li><a href="/tag/politics.html" class="tag-4">politics</a></li>
									<li><a href="/tag/information-theory.html" class="tag-4">information-theory</a></li>
									<li><a href="/tag/payments.html" class="tag-4">payments</a></li>
									<li><a href="/tag/maths.html" class="tag-1">maths</a></li>
									<li><a href="/tag/exploratory-analysis.html" class="tag-4">exploratory-analysis</a></li>
									<li><a href="/tag/ai.html" class="tag-4">ai</a></li>
									<li><a href="/tag/coding.html" class="tag-2">coding</a></li>
									<li><a href="/tag/10ideas.html" class="tag-1">10ideas</a></li>
									<li><a href="/tag/deep-learning.html" class="tag-1">deep-learning</a></li>
									<li><a href="/tag/neural-network.html" class="tag-2">neural-network</a></li>
									<li><a href="/tag/data-science.html" class="tag-1">data-science</a></li>
									<li><a href="/tag/visualization.html" class="tag-1">visualization</a></li>
									<li><a href="/tag/customer-experience.html" class="tag-1">customer-experience</a></li>
									<li><a href="/tag/networks.html" class="tag-4">networks</a></li>
									<li><a href="/tag/bitcoin.html" class="tag-4">bitcoin</a></li>
									<li><a href="/tag/uncertainty.html" class="tag-4">uncertainty</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Monthly Archives</h5>
								<ul class="side-nav">
											<li><a href="/posts/2016/11/index.html">November 2016 (3)</a></li>
											<li><a href="/posts/2016/10/index.html">October 2016 (4)</a></li>
											<li><a href="/posts/2016/03/index.html">March 2016 (1)</a></li>
											<li><a href="/posts/2016/02/index.html">February 2016 (2)</a></li>
											<li><a href="/posts/2016/01/index.html">January 2016 (1)</a></li>
											<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
											<li><a href="/posts/2015/03/index.html">March 2015 (2)</a></li>
											<li><a href="/posts/2015/02/index.html">February 2015 (6)</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Social</h5>
								<ul class="side-nav">
									<li><a href="http://github.com/simonb83">GitHub</a></li>
									<li><a href="https://mx.linkedin.com/in/simonbedford">LinkedIn</a></li>
									<li><a href="http://twitter.com/simonb83">Twitter</a></li>
								</ul>
							</div>
						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="https://simonb83.github.io/theme/js/jquery.js"></script>
		<script src="https://simonb83.github.io/theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>

	</body>
</html>